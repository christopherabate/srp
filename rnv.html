<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" crossorigin="anonymous">
    <link href="assets/css/srp.css" rel="stylesheet">
    <style>
      #braille .row .col:nth-child(1),
      #viewer .row .col:nth-child(1),
      #history .row .col:nth-child(1) {
          text-align: right;
      }

      #braille .row .col:nth-child(2),
      #viewer .row .col:nth-child(2),
      #history .row .col:nth-child(2) {
          text-align: center;
      }

      #braille .row .col:nth-child(3),
      #viewer .row .col:nth-child(3),
      #history .row .col:nth-child(3) {
          text-align: left;
      }
      
      #history .row:nth-child(1) {
          opacity: .75;
      }

      #history .row:nth-child(2) {
          opacity: .50;
      }

      #history .row:nth-child(3) {
          opacity: .25;
      }
    </style>
    <title>Screen Reader Puzzle</title>
  </head>
  <body>
    <div class="d-flex align-items-center vh-100">
      <main role="main" class="container-fluid lead">
        <div id="braille"></div>
        <div id="viewer" class="fw-semibold"></div>
        <div id="history"></div>
        <div id="keyboard" class="text-center mt-5 d-flex justify-content-center align-items-center">
          <div>
            <div class="d-flex justify-content-center">
              <button class="m-1 shadow btn btn-primary" data-key="Escape" data-keycode="27">Escape</button>
              <button class="m-1 shadow btn btn-secondary" disabled>A</button>
              <button class="m-1 shadow btn btn-secondary" disabled>Z</button>
              <button class="m-1 shadow btn btn-secondary" disabled>E</button>
              <button class="m-1 shadow btn btn-secondary" disabled>R</button>
              <button class="m-1 shadow btn btn-secondary" disabled>T</button>
              <button class="m-1 shadow btn btn-secondary" disabled>Y</button>
              <button class="m-1 shadow btn btn-secondary" disabled>U</button>
              <button class="m-1 shadow btn btn-primary" data-key="i" data-keycode="73">I</button>
              <button class="m-1 shadow btn btn-secondary" disabled>O</button>
              <button class="m-1 shadow btn btn-secondary" disabled>P</button>
            </div>
            <div class="d-flex justify-content-center">
              <button class="m-1 shadow btn btn-primary" data-key="Tab" data-keycode="9">Tab</button>
              <button class="m-1 shadow btn btn-secondary" disabled>Q</button>
              <button class="m-1 shadow btn btn-secondary" disabled>S</button>
              <button class="m-1 shadow btn btn-primary" data-key="d" data-keycode="68">D</button>
              <button class="m-1 shadow btn btn-secondary" disabled>F</button>
              <button class="m-1 shadow btn btn-secondary" disabled>G</button>
              <button class="m-1 shadow btn btn-primary" data-key="h" data-keycode="72">H</button>
              <button class="m-1 shadow btn btn-secondary" disabled>J</button>
              <button class="m-1 shadow btn btn-secondary" disabled>K</button>
              <button class="m-1 shadow btn btn-secondary" disabled>L</button>
              <button class="m-1 shadow btn btn-secondary" disabled>M</button>
            </div>
            <div class="d-flex justify-content-center">
              <button class="m-1 shadow btn btn-primary" data-key="Shift" data-keycode="16">Shift</button>
              <button class="m-1 shadow btn btn-secondary" disabled>W</button>
              <button class="m-1 shadow btn btn-secondary" disabled>X</button>
              <button class="m-1 shadow btn btn-secondary" disabled>C</button>
              <button class="m-1 shadow btn btn-secondary" disabled>V</button>
              <button class="m-1 shadow btn btn-secondary" disabled>B</button>
              <button class="m-1 shadow btn btn-secondary" disabled>N</button>
              <button class="m-1 shadow btn btn-primary" data-key="Enter" data-keycode="13">Enter</button>
            </div>
            <div class="d-flex justify-content-center">
              <button class="m-1 shadow btn btn-primary" data-key=" " data-keycode="32">Space</button>
            </div>
          </div>
          <div>
            <div>
              <button class="m-1 shadow btn btn-primary" data-key="ArrowUp" data-keycode="38"><i class="bi bi-arrow-up"></i></button>
            </div>
            <div>
              <button class="m-1 shadow btn btn-secondary" disabled><i class="bi bi-arrow-left"></i></button>
              <button class="m-1 shadow btn btn-primary" data-key="ArrowDown" data-keycode="40"><i class="bi bi-arrow-down"></i></button>
              <button class="m-1 shadow btn btn-secondary" disabled><i class="bi bi-arrow-right"></i></button>
            </div>
          </div>
        </div>
      </main>
    </div>
    <iframe id="screen" class="invisible" title="Puzzle" src="screen.html"></iframe>
  </body>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
  <script type="module">
    import { ELEMENTS } from './assets/js/elements.js';
    import { ScreenReader } from './assets/js/screenreader.js';
    import { accName } from './assets/js/accname.js';
    import { braille } from './assets/js/braille.js';
    
    console.log(braille('Bonjor éàç"+./é bàè àé à) )à è07°7156*/--)à_°0$`ù*£%*¨^è 3è b)è v)céà"é"à<123&é"(§è!çàtçègb  àè" g)bàèa )'));

    // DOM elements
    const KEYBOARD = document.querySelector("#keyboard");
    const SCREEN = document.querySelector("#screen");
    const BRAILLE = document.querySelector("#braille");
    const VIEWER = document.querySelector("#viewer");
    const HISTORY = document.querySelector("#history");

    // On page load
    window.addEventListener("load", () => {
      // Initialize screen reader
      const sr = new ScreenReader(SCREEN, ELEMENTS);
      
      sr.addEventListener('change', function() {
        if (HISTORY.children.length >= 3) {
          HISTORY.removeChild(HISTORY.lastChild);
        }
        HISTORY.innerHTML = VIEWER.innerHTML + HISTORY.innerHTML;
        BRAILLE.innerHTML = `<div class="row">${Object.values(this.speak({ wrapper: accName })).map((data) => [`<div class="col">${braille(data.length > 50 ? data.substring(0, 49) + '&hellip;' : data)}</div>`]).join("")}</div>`;
        VIEWER.innerHTML = `<div class="row">${Object.values(this.speak({ wrapper: accName })).map((data) => [`<div class="col">${data.length > 50 ? data.substring(0, 49) + '&hellip;' : data}</div>`]).join("")}</div>`;
        speechSynthesis.cancel();
        speechSynthesis.speak(new SpeechSynthesisUtterance(VIEWER.innerText));
      });
      
      BRAILLE.innerHTML = `<div class="row"><div class="col">${braille('Titre de la page')}</div><div class="col">${braille(sr.title)}</div><div class="col"></div></div>`;
      VIEWER.innerHTML = `<div class="row"><div class="col">Titre de la page</div><div class="col">${sr.title}</div><div class="col"></div></div>`;
      
      // Key actions mapping
      const keyActions = {
        arrowdown: () => sr.move(),
        arrowup: () => sr.move({ reverse: true }),
        h: (shiftKey) => sr.move({ list: "headings", reverse: shiftKey }),
        i: (shiftKey) => sr.move({ list: "listitems", reverse: shiftKey }),
        d: (shiftKey) => sr.move({ list: "landmarks", reverse: shiftKey }),
        tab: (shiftKey) => sr.move({ list: "interactives", reverse: shiftKey }),
        enter: () => sr.activate(),
        " ": () => sr.activate(),
        escape: () => sr.collection[sr.current].dispatchEvent(new KeyboardEvent("keydown", { key: "Escape", keyCode: 27, which: 27, bubbles: true, cancelable: true })),
      };

      // Wait for a key press
      window.addEventListener("keydown", (event) => {
        const action = keyActions[event.key.toLowerCase()];
        if (action) {
          event.preventDefault();
          action(event.shiftKey);
        }
        
        if (event.key.toLowerCase() === "shift") {
          KEYBOARD.querySelector('[data-key="Shift"]').classList.add("active");
        } 
      });
      
      // Key up event to disable Shift button when released
      window.addEventListener("keyup", (event) => {
        if (event.key.toLowerCase() === "shift") {
          KEYBOARD.querySelector('[data-key="Shift"]').classList.remove("active");
        }
      });
      
      // Event listener for button click in CONTROLS
      KEYBOARD.querySelectorAll("button").forEach((button) => {
        button.addEventListener("click", (event) => {
          event.preventDefault();
          const { key, keycode, price } = event.target.closest("button").dataset;

          // Dispatch keyboard event if key and keyCode are valid
          if (key && keycode) {
            window.dispatchEvent(new KeyboardEvent("keydown", {
              key,
              keyCode: keycode,
              which: keycode,
              bubbles: true,
              cancelable: true,
              shiftKey: event.shiftKey
            }));
          }
        });
      });
    });
  </script>
</html>