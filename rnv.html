<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" crossorigin="anonymous">
    <link href="assets/css/srp.css" rel="stylesheet">
    <title>Screen Reader Puzzle: Role, name, value</title>
  </head>
  <body>
    <div class="d-flex align-items-center vh-100">
      <main role="main" class="container-fluid lead">
        <div class="d-flex justify-content-center text-center">
          <div id="role" class="mx-3">
            <div class="title fw-bold">ROLE</div>
            <div class="viewer"></div>
            <div class="braille"></div>
          </div>
          <div id="name" class="mx-3">
            <div class="title fw-bold">NAME</div>
            <div class="viewer"></div>
            <div class="braille"></div>
          </div>
          <div id="value" class="mx-3">
            <div class="title fw-bold">VALUE</div>
            <div class="viewer"></div>
            <div class="braille"></div>
          </div>
        </div>
        <div id="keyboard" class="text-center mt-3 d-flex justify-content-center align-items-center">
          <div>
            <div class="d-flex justify-content-center">
              <button class="m-1 shadow btn btn-primary" data-key="Escape" data-keycode="27">Escape</button>
              <button class="m-1 shadow d-none d-md-inline btn btn-secondary" disabled>A</button>
              <button class="m-1 shadow d-none d-md-inline btn btn-secondary" disabled>Z</button>
              <button class="m-1 shadow d-none d-md-inline btn btn-secondary" disabled>E</button>
              <button class="m-1 shadow d-none d-md-inline btn btn-secondary" disabled>R</button>
              <button class="m-1 shadow d-none d-md-inline btn btn-secondary" disabled>T</button>
              <button class="m-1 shadow d-none d-md-inline btn btn-secondary" disabled>Y</button>
              <button class="m-1 shadow d-none d-md-inline btn btn-secondary" disabled>U</button>
              <button class="m-1 shadow btn btn-primary" data-key="i" data-keycode="73">I</button>
              <button class="m-1 shadow d-none d-md-inline btn btn-secondary" disabled>O</button>
              <button class="m-1 shadow d-none d-md-inline btn btn-secondary" disabled>P</button>
            </div>
            <div class="d-flex justify-content-center">
              <button class="m-1 shadow btn btn-primary" data-key="Tab" data-keycode="9">Tab</button>
              <button class="m-1 shadow d-none d-md-inline btn btn-secondary" disabled>Q</button>
              <button class="m-1 shadow d-none d-md-inline btn btn-secondary" disabled>S</button>
              <button class="m-1 shadow btn btn-primary" data-key="d" data-keycode="68">D</button>
              <button class="m-1 shadow d-none d-md-inline btn btn-secondary" disabled>F</button>
              <button class="m-1 shadow d-none d-md-inline btn btn-secondary" disabled>G</button>
              <button class="m-1 shadow btn btn-primary" data-key="h" data-keycode="72">H</button>
              <button class="m-1 shadow d-none d-md-inline btn btn-secondary" disabled>J</button>
              <button class="m-1 shadow d-none d-md-inline btn btn-secondary" disabled>K</button>
              <button class="m-1 shadow d-none d-md-inline btn btn-secondary" disabled>L</button>
              <button class="m-1 shadow d-none d-md-inline btn btn-secondary" disabled>M</button>
            </div>
            <div class="d-flex justify-content-center">
              <button class="m-1 shadow btn btn-primary" data-key="Shift" data-keycode="16">Shift</button>
              <button class="m-1 d-none d-md-inline shadow btn btn-secondary" disabled>W</button>
              <button class="m-1 d-none d-md-inline shadow btn btn-secondary" disabled>X</button>
              <button class="m-1 d-none d-md-inline shadow btn btn-secondary" disabled>C</button>
              <button class="m-1 d-none d-md-inline shadow btn btn-secondary" disabled>V</button>
              <button class="m-1 d-none d-md-inline shadow btn btn-secondary" disabled>B</button>
              <button class="m-1 d-none d-md-inline shadow btn btn-secondary" disabled>N</button>
              <button class="m-1 shadow btn btn-primary" data-key="Enter" data-keycode="13">Enter</button>
            </div>
            <div class="d-flex justify-content-center">
              <button class="m-1 shadow btn btn-primary" data-key=" " data-keycode="32">Space</button>
            </div>
          </div>
          <div>
            <div>
              <button class="m-1 shadow btn btn-primary" data-key="ArrowUp" data-keycode="38"><i class="bi bi-arrow-up"></i></button>
            </div>
            <div>
              <button class="m-1 shadow d-none d-md-inline btn btn-secondary" disabled><i class="bi bi-arrow-left"></i></button>
              <button class="m-1 shadow btn btn-primary" data-key="ArrowDown" data-keycode="40"><i class="bi bi-arrow-down"></i></button>
              <button class="m-1 shadow d-none d-md-inline btn btn-secondary" disabled><i class="bi bi-arrow-right"></i></button>
            </div>
          </div>
        </div>
      </main>
    </div>
    <iframe id="screen" class="invisible" title="Puzzle" src="screen.html"></iframe>
  </body>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
  <script type="module">
    import { ELEMENTS } from './assets/js/elements.js';
    import { ScreenReader } from './assets/js/screenreader.js';
    import { accName } from './assets/js/accname.js';
    import { braille } from './assets/js/braille.js';

    // DOM elements
    const KEYBOARD = document.querySelector("#keyboard");
    const SCREEN = document.querySelector("#screen");
    const VIEWS = {
      role: document.querySelector("#role"),
      name: document.querySelector("#name"),
      value: document.querySelector("#value")
    };

    // On page load
    window.addEventListener("load", () => {
      // Initialize screen reader
      const sr = new ScreenReader(SCREEN, ELEMENTS);
      
      // Function view to update the "viewer" and "braille" elements
      function view(data) {
        ['role', 'name', 'value'].forEach((key) => {
          data[key] = data[key].length > 30 ? data[key].substring(0, 29) + '&hellip;' : data[key]
          VIEWS[key].querySelector(".viewer").innerHTML = data[key];
          VIEWS[key].querySelector(".braille").innerHTML = braille(data[key]);
        });
        
        speechSynthesis.cancel();
        speechSynthesis.speak(new SpeechSynthesisUtterance(Object.values(data).join(" ")));
      }

      // Event listener for the change event
      sr.addEventListener('change', function() {
        view(this.speak({ wrapper: accName }));
      });

      // Initial page load
      view({
        role: "Titre de la page",
        name: sr.title,
        value: ""
      });
      
      // Key actions mapping
      const keyActions = {
        arrowdown: () => sr.move(),
        arrowup: () => sr.move({ reverse: true }),
        h: (shiftKey) => sr.move({ list: "headings", reverse: shiftKey }),
        i: (shiftKey) => sr.move({ list: "listitems", reverse: shiftKey }),
        d: (shiftKey) => sr.move({ list: "landmarks", reverse: shiftKey }),
        tab: (shiftKey) => sr.move({ list: "interactives", reverse: shiftKey }),
        enter: () => sr.activate(),
        " ": () => sr.activate(),
        escape: () => sr.collection[sr.current].dispatchEvent(new KeyboardEvent("keydown", { key: "Escape", keyCode: 27, which: 27, bubbles: true, cancelable: true })),
      };

      // Wait for a key press
      window.addEventListener("keydown", (event) => {
        const action = keyActions[event.key.toLowerCase()];
        if (action) {
          event.preventDefault();
          action(event.shiftKey);
        }
        
        if (event.key.toLowerCase() === "shift") {
          KEYBOARD.querySelector('[data-key="Shift"]').classList.add("active");
        } 
      });
      
      // Key up event to disable Shift button when released
      window.addEventListener("keyup", (event) => {
        if (event.key.toLowerCase() === "shift") {
          KEYBOARD.querySelector('[data-key="Shift"]').classList.remove("active");
        }
      });
      
      // Event listener for button click in CONTROLS
      KEYBOARD.querySelectorAll("button").forEach((button) => {
        button.addEventListener("click", (event) => {
          event.preventDefault();
          const { key, keycode, price } = event.target.closest("button").dataset;

          // Dispatch keyboard event if key and keyCode are valid
          if (key && keycode) {
            window.dispatchEvent(new KeyboardEvent("keydown", {
              key,
              keyCode: keycode,
              which: keycode,
              bubbles: true,
              cancelable: true,
              shiftKey: event.shiftKey
            }));
          }
        });
      });
    });
  </script>
</html>